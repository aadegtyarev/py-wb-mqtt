# py-wb-mqtt
## Описание
Обёртка для удобной работы с девайсами [Wiren Board](https://wirenboard.com) из Python.

В контроллере Wiren Board обмен информацией идёт через MQTT-брокер, где согласно конвенции создаются устройства. Из коробки для Python предлагается использовать библиотеку paho-mqtt и оперировать длинными топиками, что неудобно.

У Wiren Board есть штатное средство для создания сценариев автоматизации [wb-rules](https://wirenboard.com/wiki/Wb-rules), но у него есть недостатки: нет модулей сообщества под разные задачи, нельзя запустить и отладить скрипты на компьютере. Использование Python позволяет писать скрипты так, как вы привыкли и отлаживать их в привычной IDE: запускаете скрипты локально на комьютере и подклчюаетесь к контроллеру по MQTT.

Файлы в репозитории:
- Модуль `module/py_wb_mqtt.py`
- Пример скрипта `script.py`

Делалось «для себя», без гарантий и техподдержки, только для тех, кто понимает, что делает.

## Начало работы
Чтобы начать работу:
1. клонируйте репозиторий;
2. создайте рядом с папкой `module` скрипт;
3. подключите модуль к своему скрипту, создайте объект и укажите параметры подключения к MQTT-брокеру. 

Минимальный пример скрипта:
```python
# Импорт модуля
from module.py_wb_mqtt import WbMqtt

# Создание объекта и передача параметров подключения
wb = WbMqtt("wirenboard-a25ndemj.local", 1883)  # server, port, username, password

# Объявление функции для обработки подписки
def log(device_id, control_id, new_value):
    print("log: %s %s %s" % (device_id, control_id, new_value))

# Подписка на все топики устройства system
wb.subscribe('system/+', log)
# Подписка на значение LVA15 устройства metrics
wb.subscribe('metrics/load_average_15min', log)

try:
    # Зацикливание скрипта, чтобы он не завершался
    wb.loop_forever()
finally:
    # Очистка винтуальных устройств и подписок перед выходом
    wb.clear()
```

## Разворачивание проекта на контроллере
Чтобы развернуть проект:
1. Скопируйте файлы модуля и ваших скриптов на контроллер в удобную папку.
2. Создайте сервис, который будет запускаться при старте ОС контроллера.

## Работа с контролами устройств
Обёртка скрывает от пользователя длинные имена топиков, предоставляя простой индерфейс взаимодействия с контролами устройств, позволяя читать и писать данные используя короткую запись пути `device_id/control_id`:
```python
# Запись значения в контрол устройства
wb.set("wb-mr6c_226/K1", new_value)

# Чтение значения из контрола
print(wb.get("wb-mr6c_226/K1"))
```

## Подписка на контролы
Кроме этого можно подписаться на один или несколько контролов, в том числе с использованием символа подстановки `+`. Обработка события происходит в функции обратного вызова, которую нужно задать. Функция возвращает:
- `device_id` — идентификатор устройства;
- `control_id` — идентификатор контрола;
- `new_value` — новое значение контрола, преобразованное к одному из типов (`float`, `int`, `str`).

К одной функции можно привязать несколько подписок:
```python
# Функция обратного вызова
def log(device_id, control_id, new_value):
    print("log: %s %s %s" % (device_id, control_id, new_value))

# Подписка с использованием символов подстановки
wb.subscribe('wb-gpio/+', log)

# Подписка на один контрол
wb.subscribe("wb-mr6c_226/K1", log)
```

Также можнго отписаться от контрола, если это нужно: 
```python
wb.unsubscribe("wb-mr6c_226/K1")
```

## Подписка на ошибки
При работе с устройствами через драйвер wb-mqtt-serial можно получать ошибки обмена, которые публикуются драйвером в MQTT:
- r — ошибка чтения из устройства;
- w — ошибка записи в устройство;
- p — драйвер не смог выдержать заданные период опроса.

В одном сообщении может быть несколько ошибок, например `rwp` или `rp`.

Подписаться на ошибки определённого контрола:
```python

# Функция обратного вызова
def log_errors(device_id, control_id, error_value):
    print("log_errors: %s %s %s" % (device_id, control_id, error_value))

# Подписка на ошибки контрола wb-mr6c_226/K1
wb.subscribe_errors("wb-mr6c_226/K1", log_errors)

# Описка от ошибок контрола wb-mr6c_226/K1
wb.unsubscribe_errors("wb-mr6c_226/K1")

```
Можно использовать символ подстановки  `+`, например:
```python
# Подписка на все ошибки модуля wb-mr6c_226
wb.subscribe_errors("wb-mr6c_226/+", log_errors)
```

## Подписка на произвольные MQTT-топики
Иногда нужно работать с топиками сторонних устройств, которые ничего не знают про конвенцию Wiren Board. Для этого есть функции подписки, отписки и публикации с указанием полного имени топика. Обработка события происходит в функции обратного вызова, которую нужно задать. Функция возвращает два параметра:
- `mqtt_topic` — полный путь к топику;
- `new_value` — новое значение типа str.

При подписке можно использовать символы подстановки `+` — подписаться на один уровень и `#` — подписаться на все уровни ниже.

Пример:
```python
# Функция обратного вызова
def log_raw(mqtt_topic, new_value):
    print("log_raw: %s %s" % (mqtt_topic, new_value))

# Подписка на топик
wb.subscribe_raw('/wbrules/#', log_raw)

# Публикация нового значения в топик
wb.publish_raw('/wbrules/log/info', 'New Log Value')

# Отписка от топика
wb.unsubscribe_raw('/wbrules/#')

```

## Виртуальные устройства

Также можно создавать виртуальные устройства с произвольным количеством контролов и использовать их для взаимодействия с пользователем или хранения данных:
```python
# функция задания
wb.create_virtual_device(
    "my-device", # идентификатор устройства
    {"ru": "Моё устройство", "en": "My Device"}, # заголовой устройства (title)
    [
        {
            "name": "temp", # идентификатор контрола в mqtt. Обязательно.     
            "title": {"ru": "Температура", "en": "Temperature"}, # заголовок контрола (title). Обязательно.
            "type": "value", # тип контрола. Обязательно.
            "default": 50, # значение по умолчанию
            "order": 1, # порядковый номер для сортировки
            "units": "°C" # единица измерения          
        },
        {
            "name": "set_temp",
            "title": {"ru": "Уставка", "en": "Set Temperature"},
            "type": "value",
            "readonly": False, # запрещает редактировать контрол. По умолчанию True.
            "default": 12.5,
            "order": 2,
            "units": "°C",
            "min": 0,
            "max": 100        
        },        
        {
            "name": "slider",
            "title": {"ru": "Ползунок", "en": "Slider"},
            "type": "range",
            "default": 13,
            "order": 3,
            "units": "%",
            "min": 10,
            "max": 35
        },          
        {
            "name": "switch",
            "title": {"ru": "Переключатель", "en": "Switch"},
            "type": "switch",
            "default": 1,
            "order": 4,
        },
        {
            "name": "log",
            "title": "Текстовый контрол",
            "type": "text",
            "default": "",
            "order": 5,
        },      
    ],
)
```
Заголовок (title) устройства и контролов можно указывать строкой `"My Device Title"` или словарём с указанием языков `{"ru": "Переключатель", "en": "Switch 1"}`.

Контролы передаются массивом словарей. Описание контролов соответствует текущей [конценции Wiren Board](https://github.com/wirenboard/conventions), за исключением `default` для `switch`, в модуле надо использовать значения `0` и `1`.

Список типов и доступные параметры для каждого типа:
| type       | Возможные значения               | default | order | units | min/max | readonly |
|------------|----------------------------------|---------|-------|-------|---------|----------|
| value      | любые числа: int, float          | +       |+      |+      |+        |+         |
| range      | любые числа: int, float          | +       |+      |+      |+        |+         |
| rgb        | формат "R;G;B", каждое 0...255   | +       |+      |+      |         |+         |
| text       | текст                            | +       |+      |+      |         |+         |
| alarm      | текст                            | +       |+      |       |         |          |
| switch     | 0 или 1                          | +       |+      |       |         |+         |
| pushbutton | 1                                | +       |+      |       |         |          |

Список доступных `units`:
| Значение  | Описание, EN |
|---        |---          |
| mm/h      | mm per hour, precipitation rate (rainfall rate) |
| m/s       | meter per second, speed |
| W         | watt, power |
| kWh       | kilowatt hour, power consumption |
| V         | voltage |
| mV        | voltage (millivolts) |
| m^3/h     | cubic meters per hour, flow |
| m^3       | cubic meters, volume |
| Gcal/h    | giga calories per hour, heat power |
| cal       | calories, energy |
| Gcal      | giga calories, energy |
| Ohm       | resistance |
| mOhm      | resistance (milliohms) |
| bar       | pressure |
| mbar      | pressure (100Pa) |
| s         | second |
| min       | minute |
| h         | hour |
| m         | meter |
| g         | gram |
| kg        | kilo gram |
| mol       | mole, amount of substance |
| cd        | candela, luminous intensity |
| %, RH     | relative humidity |
| deg C     | temperature |
| %         | percent |
| ppm       | parts per million |
| ppb       | parts per billion |
| A         | ampere, current |
| mA        | milliampere, current |
| deg       | degree, angle |
| rad       | radian, angle |

## Известные проблемы
Не всегда удаляются созданные виртуальные устройства. Возможно, скрипт завершается раньше, чем успевают отработать процедуры удаления.

При установке надо создать описание спрвиса для автозапуска, поэтому обновлять софт контроллера надо строго через apt. При обновлении с флешки или в веб-интерфейсе описание сервиса будет удалено. Как костыль, можно на wb-rules написать скрипт, который будет разпускать скрипт на питоне :D